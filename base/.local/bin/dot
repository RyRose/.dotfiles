#!/usr/bin/env -S uv run --script
# /// script
# dependencies = [
#     "typer",
# ]
# ///

from pathlib import Path
from typing import Annotated
import os
import shutil
import subprocess
import typer

app = typer.Typer(help="Manage dotfiles.", no_args_is_help=True)

nix = typer.Typer(help="Nix related commands.", no_args_is_help=True)
app.add_typer(nix, name="nix")


@nix.command(help="Reload NixOS configuration.")
def reload():
    subprocess.run("reload_nixos")


@nix.command(help="Update NixOS system.")
def update():
    subprocess.run("update_nixos")


@nix.command(help="Rollback NixOS system.")
def rollback():
    subprocess.run("rollback_nixos")


@app.command(help="Run make in the dotfiles directory on a target.")
def make(target: Annotated[str, typer.Argument()] = ""):
    assert shutil.which("make"), "Make is not installed."
    assert shutil.which("stow"), "Stow is not installed."

    os.chdir(Path.home() / ".dotfiles")
    subprocess.run(["make", target])


@app.command(help="Edit dotfiles in Neovim.")
def edit():
    os.chdir(Path.home() / ".dotfiles")
    subprocess.run(["nvim"])


if __name__ == "__main__":
    app()
